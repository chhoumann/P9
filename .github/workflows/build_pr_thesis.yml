name: "Build Thesis Document for PR"
on: 
  pull_request:
    paths:
      - 'report_thesis/**'
permissions:
    contents: write
defaults:
    run:
        working-directory: report_thesis
jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v3
            - uses: actions/cache@v3
              name: Tectonic Cache
              with:
                  path: ~/.cache/tectonic
                  key: ${{ runner.os }}-tectonic-${{ hashFiles('**/*.tex') }}
                  restore-keys: |
                      ${{ runner.os }}-tectonic-
            - uses: wtfjoke/setup-tectonic@v2
              with:
                  github-token: ${{ secrets.github_token }}
            - name: Run Tectonic
              run: tectonic -X build
            - name: Upload PDF
              uses: actions/upload-artifact@v2
              with:
                  name: thesis-pdf
                  path: report_thesis/build/thesis/thesis.pdf
            - name: Post comment with PDF link
              uses: actions/github-script@v6
              with:
                  script: |
                    const pdfUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/suites/${context.runId}/artifacts/${context.runId}`;
                    const comment = `Built PDF for this PR: [Download PDF](${pdfUrl})`;
                    await github.rest.issues.createComment({
                      ...context.repo,
                      issue_number: context.issue.number,
                      body: comment
                    });